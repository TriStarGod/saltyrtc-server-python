#!/usr/bin/env python3
"""
The command line interface for the SaltyRTC Signalling Server.
"""
import functools
import asyncio

import click

from saltyrtc.server import __version__ as _version
from saltyrtc import server


def aio_run(func, run_forever=False):
    func = asyncio.coroutine(func)

    def _wrapper(*args, **kwargs):
        loop = asyncio.get_event_loop()
        task = loop.create_task(func(*args, **kwargs))
        loop.run_until_complete(task)
        if run_forever:
            loop.run_forever()
        return task.result()
    return functools.update_wrapper(_wrapper, func)


def aio_serve(func):
    return aio_run(func, run_forever=True)


@click.group()
@click.pass_context
def cli(ctx):
    """
    Command Line Interface. Use --help for details.
    """
    ctx.obj = {}


@cli.command(short_help='Show version information.', help="""
Show the current version of the SaltyRTC Signalling Server.
""")
def version():
    click.echo('Version: {}'.format(_version))


@cli.command()
@aio_serve
def serve():
    yield from server.serve()


if __name__ == '__main__':
    with server.logging_handler.applicationbound():
        try:
            cli()
        except Exception as exc:
            click.echo('An error occurred:', err=True)
            click.echo(exc, err=True)
